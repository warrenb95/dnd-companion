# LiteFS configuration for D&D Campaign Builder
# https://fly.io/docs/litefs/getting-started/

# The fuse section handles mounting the file system.
fuse:
  dir: "/litefs"

# The data section handles where the SQLite database files are stored.
data:
  dir: "/var/lib/litefs"

# This flag ensure that LiteFS continues to run if there is an issue on startup.
# It makes it easier to debug any issues you might be having rather than 
# continuously restarting on initialization failure.
exit-on-error: false

# This section defines settings for the option HTTP proxy.
# This proxy can handle primary forwarding & replica consistency
# for applications that use a single SQLite database.
proxy:
  addr: ":8080"
  target: "localhost:8000"
  db: "db.sqlite3"

# Define the lease configuration
lease:
  type: "consul"
  advertise-url: "http://${HOSTNAME}.vm.${FLY_APP_NAME}.internal:20202"
  candidate: ${FLY_REGION == PRIMARY_REGION}
  
  consul:
    url: "${FLY_CONSUL_URL}"
    key: "litefs/${FLY_APP_NAME}"

# The backup section handles backing up your database to another system.
backup:
  # Backup to S3-compatible storage
  type: "s3"
  
  # S3 configuration
  s3:
    bucket: "${BACKUP_BUCKET}"
    path: "dnd-companion"
    region: "${BACKUP_REGION}"
    
  # Retention policy
  retention: "24h"
  retention-monitor-interval: "1h"

# Prometheus metrics
prometheus:
  addr: ":9090"

# Tracing
tracing:
  level: "info"