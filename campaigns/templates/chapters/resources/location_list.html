{% extends "base.html" %}
{% load markdown_extras %}
{% block title %}Locations - {{ chapter.title }} - {{ campaign.title }}{% endblock %}

{% block content %}
<div class="my-4 sm:my-8 max-w-screen-xl mx-auto px-4">
  <div class="flex items-center justify-between mb-6">
    <div>
      <a href="{% url 'campaigns:chapter_detail' campaign_id=campaign.id chapter_id=chapter.id %}"
         class="inline-flex items-center text-indigo-400 hover:text-indigo-300 text-sm mb-2">
        <i class="fas fa-arrow-left mr-2"></i>Back to Chapter
      </a>
      <h1 class="text-3xl font-bold text-white">Locations in {{ chapter.title }}</h1>
      <p class="text-gray-400 mt-1">{{ campaign.title }}</p>
    </div>
    <a href="{% url 'campaigns:location_create' campaign_id=campaign.id %}"
       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
      <i class="fas fa-plus mr-2"></i>Add New Location
    </a>
  </div>

  {% if locations %}
  <div class="bg-gray-800 rounded-lg shadow overflow-hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
      {% for location in locations %}
      <div class="bg-gray-700 rounded-lg overflow-hidden hover:bg-gray-650 transition-colors">
        {% if location.map_image %}
        <div class="h-48 relative">
          <img src="{{ location.map_image.url }}" 
               alt="Map of {{ location.name }}"
               class="w-full h-full object-cover"/>
          <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
            {{ location.name }}
          </div>
        </div>
        {% endif %}
        
        <div class="p-4">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-white mb-2">
                <a href="{% url 'campaigns:location_detail' campaign_id=campaign.id location_id=location.id %}" 
                   class="hover:text-indigo-400 transition-colors">
                  {{ location.name }}
                </a>
              </h3>
              
              {% if location.region %}
              <p class="text-sm text-blue-400 mb-2">
                <i class="fas fa-globe mr-1"></i>{{ location.region }}
              </p>
              {% endif %}
              
              {% if location.description %}
              <p class="text-sm text-gray-300 mb-3 line-clamp-3">
                {{ location.description|truncatewords:20 }}
              </p>
              {% endif %}
              
              {% if location.tags %}
              <div class="flex flex-wrap gap-1 mb-3">
                {% for tag in location.tags|split:"," %}
                  {% if tag.strip %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {{ tag.strip }}
                  </span>
                  {% endif %}
                {% endfor %}
              </div>
              {% endif %}
              
              <!-- Show encounters that use this location -->
              {% if location.encounter_set.exists %}
              <div class="mt-3">
                <p class="text-xs text-gray-400 mb-1">Used in encounters:</p>
                <div class="flex flex-wrap gap-1">
                  {% for encounter in location.encounter_set.all %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                    {{ encounter.title }}
                  </span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
            
            <div class="flex flex-col gap-2 ml-3">
              <a href="{% url 'campaigns:location_edit' campaign_id=campaign.id location_id=location.id %}"
                 class="text-indigo-400 hover:text-indigo-300 p-1 rounded transition-colors"
                 title="Edit Location">
                <i class="fas fa-edit"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% if is_paginated %}
  <div class="mt-6 flex justify-center">
    <nav class="flex space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page=1" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">First</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Previous</a>
      {% endif %}
      
      <span class="px-3 py-2 bg-indigo-600 text-white rounded">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
      
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Next</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Last</a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

  {% else %}
  <div class="bg-gray-800 rounded-lg p-8 text-center">
    <i class="fas fa-map-marker-alt text-gray-500 text-4xl mb-4"></i>
    <h3 class="text-xl font-semibold text-white mb-2">No Locations in this Chapter</h3>
    <p class="text-gray-400 mb-4">This chapter doesn't have any locations associated with it yet.</p>
    <a href="{% url 'campaigns:location_create' campaign_id=campaign.id %}"
       class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
      <i class="fas fa-plus mr-2"></i>Add First Location
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}