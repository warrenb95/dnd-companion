{% extends "base.html" %}
{% block title %}Chapter Details{% endblock %}

{% block content %}
<div class="my-4 sm:my-8 max-w-screen-xl mx-auto px-4 relative">
  <a href="{% url 'campaigns:campaign_detail' chapter.campaign.id %}"
     class="inline-flex items-center mb-6 text-indigo-400 hover:text-indigo-300 text-sm sm:text-base">
    <i class="fas fa-arrow-left mr-2"></i>Back to Campaign
  </a>

  <!-- Main Content: Full Width -->
  <div class="space-y-6 sm:space-y-10">
    {% include "chapters/components/_chapter_overview.html" %}

    <!-- Encounters + Notes -->
    {% include "encounters/components/_encounter_list_with_notes.html" %}
  </div>
</div>

<!-- NPC Selection Modal -->
<div id="npc-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeNPCModal()"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="w-full">
            <h3 class="text-lg leading-6 font-medium text-white mb-4" id="modal-title">
              Add NPC to Chapter
            </h3>
            <div id="npc-selection-content">
              <!-- Content will be loaded via HTMX -->
              <div class="text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-500"></div>
                <p class="text-gray-400 mt-2">Loading NPCs...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-750 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" onclick="closeNPCModal()" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Enemy Selection Modal -->
<div id="enemy-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEnemyModal()"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="w-full">
            <h3 class="text-lg leading-6 font-medium text-white mb-4" id="modal-title">
              Add Enemy to Chapter
            </h3>
            <div id="enemy-selection-content">
              <!-- Content will be loaded via HTMX -->
              <div class="text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-red-500"></div>
                <p class="text-gray-400 mt-2">Loading Enemies...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-750 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" onclick="closeEnemyModal()" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Location Selection Modal -->
<div id="location-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeLocationModal()"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="w-full">
            <h3 class="text-lg leading-6 font-medium text-white mb-4" id="modal-title">
              Add Location to Chapter
            </h3>
            <div id="location-selection-content">
              <!-- Content will be loaded via HTMX -->
              <div class="text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                <p class="text-gray-400 mt-2">Loading Locations...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-750 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" onclick="closeLocationModal()" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function openNPCModal() {
  document.getElementById('npc-modal').classList.remove('hidden');
  // Load available NPCs
  htmx.ajax('GET', '{% url "campaigns:chapter_npc_selection" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    target: '#npc-selection-content'
  });
}

function closeNPCModal() {
  document.getElementById('npc-modal').classList.add('hidden');
}

function addNPCToChapter(npcId) {
  htmx.ajax('POST', '{% url "campaigns:chapter_add_npc" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    values: { npc_id: npcId },
    target: '#npcs-section',
    swap: 'outerHTML'
  }).then(() => {
    closeNPCModal();
  });
}

function removeNPCFromChapter(npcId) {
  if (confirm('Remove this NPC from the chapter?')) {
    htmx.ajax('POST', '{% url "campaigns:chapter_remove_npc" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
      values: { npc_id: npcId },
      target: '#npcs-section',
      swap: 'outerHTML'
    });
  }
}

// Location management functions
function openLocationModal() {
  document.getElementById('location-modal').classList.remove('hidden');
  // Load available locations
  htmx.ajax('GET', '{% url "campaigns:chapter_location_selection" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    target: '#location-selection-content'
  });
}

function closeLocationModal() {
  document.getElementById('location-modal').classList.add('hidden');
}

function addLocationToChapter(locationId) {
  htmx.ajax('POST', '{% url "campaigns:chapter_add_location" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    values: { location_id: locationId },
    target: '#locations-section',
    swap: 'outerHTML'
  }).then(() => {
    closeLocationModal();
  });
}

function removeLocationFromChapter(locationId) {
  if (confirm('Remove this location from the chapter?')) {
    htmx.ajax('POST', '{% url "campaigns:chapter_remove_location" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
      values: { location_id: locationId },
      target: '#locations-section',
      swap: 'outerHTML'
    });
  }
}

// Enemy management functions
function openEnemyModal() {
  document.getElementById('enemy-modal').classList.remove('hidden');
  // Load available enemies
  htmx.ajax('GET', '{% url "campaigns:chapter_enemy_selection" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    target: '#enemy-selection-content'
  });
}

function closeEnemyModal() {
  document.getElementById('enemy-modal').classList.add('hidden');
}

function addEnemyToChapter(enemyId) {
  htmx.ajax('POST', '{% url "campaigns:chapter_add_enemy" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
    values: { enemy_id: enemyId },
    target: '#enemies-section',
    swap: 'outerHTML'
  }).then(() => {
    closeEnemyModal();
  });
}

function removeEnemyFromChapter(enemyId) {
  if (confirm('Remove this enemy from the chapter?')) {
    htmx.ajax('POST', '{% url "campaigns:chapter_remove_enemy" campaign_id=chapter.campaign.id chapter_id=chapter.id %}', {
      values: { enemy_id: enemyId },
      target: '#enemies-section',
      swap: 'outerHTML'
    });
  }
}
</script>
{% endblock %}
