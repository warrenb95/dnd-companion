{% extends "base.html" %}

{% block title %}Session Availability - {{ schedule.campaign.title }}{% endblock %}

{% block extra_css %}
<style>
/* Session Scheduling Styles - Mobile-First Vertical Layout */

.availability-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
}

@media (min-width: 768px) {
    .availability-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .availability-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.day-card {
    background: #1f2937; /* gray-800 */
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

.day-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
}

.day-header {
    border-bottom: 2px solid #374151; /* gray-700 */
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
}

.day-header .day-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: #f9fafb; /* gray-50 */
}

.day-header .day-date {
    color: #9ca3af; /* gray-400 */
    font-size: 0.875rem;
    margin: 0.25rem 0 0 0;
}

.time-slots {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.time-slot-btn {
    width: 100%;
    padding: 1rem;
    border: 2px solid #4b5563; /* gray-600 */
    border-radius: 0.5rem;
    background: #374151; /* gray-700 */
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px; /* Touch-friendly */
    color: #f9fafb; /* gray-50 */
    text-align: center;
}

.time-slot-btn:hover {
    border-color: #6b7280; /* gray-500 */
    background: #4b5563; /* gray-600 */
    transform: scale(1.02);
}

.time-slot-btn.selected {
    background: #4f46e5; /* indigo-600 */
    border-color: #4f46e5;
    color: white;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
}

.time-slot-btn.selected:hover {
    background: #4338ca; /* indigo-700 */
    border-color: #4338ca;
}

/* Loading state for HTMX */
.time-slot-btn.htmx-request {
    opacity: 0.6;
    cursor: wait;
    pointer-events: none;
}

.time-slot-btn.htmx-request::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-left: 8px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Focus states for accessibility */
.time-slot-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}

.time-slot-btn.selected:focus {
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
}

/* Responsive adjustments for very small screens */
@media (max-width: 375px) {
    .day-card {
        padding: 1rem;
    }

    .time-slot-btn {
        padding: 0.75rem;
        font-size: 0.875rem;
    }

    .day-header .day-name {
        font-size: 1.125rem;
    }
}

/* Success/Error message animations */
.alert {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Error state animations for time slot buttons */
.time-slot-btn.error-flash {
    animation: shake 0.5s, flash-red 2s;
    border-color: #dc2626 !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@keyframes flash-red {
    0% { border-color: #dc2626; background: #7f1d1d; }
    100% { border-color: #4b5563; background: #374151; }
}

.error-message-temp {
    color: #fca5a5;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    animation: fadeOut 3s forwards;
}

@keyframes fadeOut {
    0%, 70% { opacity: 1; }
    100% { opacity: 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="my-4 sm:my-10 max-w-6xl mx-auto px-4">
  <!-- Header -->
  <div class="text-center mb-6 sm:mb-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-white">{{ schedule.title }}</h2>
    <p class="text-lg sm:text-xl text-gray-300 mt-2">{{ schedule.campaign.title }}</p>
    {% if schedule.notes %}
      <div class="bg-blue-900 border border-blue-700 text-blue-200 px-4 py-3 rounded mt-4 text-sm sm:text-base">
        {{ schedule.notes|safe }}
      </div>
    {% endif %}
  </div>

  <!-- Player Info Form -->
  <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
    <div class="bg-gray-900 px-4 sm:px-6 py-4 border-b border-gray-700">
      <h3 class="text-lg sm:text-xl font-semibold text-white">Your Information</h3>
    </div>
    <div class="p-4 sm:p-6">
      {% if existing_response %}
        <div class="bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded mb-6 text-sm sm:text-base">
          You've already submitted availability for this session. You can update your selections below.
        </div>
      {% endif %}

      <form id="player-info-form">
        {% csrf_token %}
        <input type="hidden" name="token" value="{{ schedule.shareable_token }}">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
          <div>
            <label for="email-input" class="block text-sm font-medium text-white mb-2">
              Email Address *
            </label>
            <input
              type="email"
              name="email"
              id="email-input"
              required
              value="{% if existing_response %}{{ existing_response.email }}{% endif %}"
              hx-post="{% url 'campaigns:save_player_info' schedule.shareable_token %}"
              hx-trigger="blur"
              hx-include="#player-info-form"
              class="form-control w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-indigo-500"
              placeholder="your.email@example.com"
            >
            <p class="text-gray-400 text-xs sm:text-sm mt-1">We'll use this to send you session confirmations</p>
          </div>

          <div>
            <label for="player-name-input" class="block text-sm font-medium text-white mb-2">
              Your Name *
            </label>
            <input
              type="text"
              name="player_name"
              id="player-name-input"
              required
              value="{% if existing_response %}{{ existing_response.player_name }}{% endif %}"
              hx-post="{% url 'campaigns:save_player_info' schedule.shareable_token %}"
              hx-trigger="blur"
              hx-include="#player-info-form"
              class="form-control w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-indigo-500"
              placeholder="Your name"
            >
          </div>
        </div>

        <div class="mt-4 sm:mt-6">
          <label for="character-name-input" class="block text-sm font-medium text-white mb-2">
            Character Name (Optional)
          </label>
          <input
            type="text"
            name="character_name"
            id="character-name-input"
            value="{% if existing_response %}{{ existing_response.character_name }}{% endif %}"
            hx-post="{% url 'campaigns:save_player_info' schedule.shareable_token %}"
            hx-trigger="blur"
            hx-include="#player-info-form"
            class="form-control w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-indigo-500"
            placeholder="Character name"
          >
        </div>
      </form>
    </div>
  </div>

  <!-- Availability Selection -->
  <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
    <div class="bg-gray-900 px-4 sm:px-6 py-4 border-b border-gray-700">
      <h3 class="text-lg sm:text-xl font-semibold text-white">Select Your Availability</h3>
      <p class="text-gray-400 text-sm mt-1">Click the time slots when you're available to play</p>
    </div>
    <div class="p-4 sm:p-6">
      <div class="availability-grid" id="availability-container">
        {% for date_data in dates_with_slots %}
          {% include 'sessions/components/_day_card.html' with day_name=date_data.day_name date=date_data.date date_str=date_data.date_str time_slots=date_data.time_slots email=existing_response.email|default:'' player_name=existing_response.player_name|default:'' token=schedule.shareable_token %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="text-center mb-6">
    <button
      type="button"
      hx-post="{% url 'campaigns:submit_player_availability' schedule.shareable_token %}"
      hx-include="#player-info-form"
      hx-target="#success-message"
      hx-swap="innerHTML"
      class="w-full sm:w-auto btn-dark-success text-base sm:text-lg px-6 sm:px-8 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
    >
      Submit Availability
    </button>
  </div>

  <!-- Success/Error message will appear here -->
  <div id="success-message"></div>

  <!-- Info -->
  <div class="text-center mt-4 sm:mt-6 text-gray-400">
    <p class="text-xs sm:text-sm">
      Session Duration: {{ schedule.session_duration }} hours |
      Date Range: {{ schedule.date_range_start|date:"M j" }} - {{ schedule.date_range_end|date:"M j, Y" }}
    </p>
  </div>
</div>

{% include "components/_dark_form_styles.html" %}
{% endblock %}
