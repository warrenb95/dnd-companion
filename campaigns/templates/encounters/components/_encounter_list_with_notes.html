{% load markdown_extras %}

<div class="bg-gray-800 rounded-lg shadow">
  <div class="border-b border-gray-700 px-6 py-4 flex justify-between items-center">
    <h2 class="text-2xl font-semibold text-white">Encounters & Notes</h2>
    <a href="{% url 'campaigns:encounter_create' campaign_id=chapter.campaign.id chapter_id=chapter.id %}" 
       class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-200">
      Add Encounter
    </a>
  </div>
  <div class="p-6 space-y-10">
    {% if encounters %} {% for enc in encounters %}
    <div class="bg-gray-700 rounded-lg overflow-hidden shadow">
      <div class="flex flex-col lg:flex-row">
        <!-- Encounter Info -->
        <div class="lg:w-1/2 p-4 text-gray-300 space-y-2">
          <div class="flex justify-between items-start">
            <h3 class="text-xl font-semibold text-white">
              {{ enc.order }}. {{ enc.title }}
              <span class="text-sm text-gray-400">({{ enc.type }})</span>
              {% if enc.is_optional %}
              <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Optional</span>
              {% endif %}
            </h3>
            <div class="flex gap-2">
              <a href="{% url 'campaigns:encounter_play' campaign_id=enc.chapter.campaign.id chapter_id=enc.chapter.id encounter_id=enc.id %}"
                 class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200">
                <i class="fas fa-play mr-1"></i>Play
              </a>
              <a href="{% url 'campaigns:encounter_export' campaign_id=enc.chapter.campaign.id chapter_id=enc.chapter.id encounter_id=enc.id %}"
                 class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200"
                 title="Export notes as markdown">
                <i class="fas fa-file-download mr-1"></i>Export
              </a>
              <a href="{% url 'campaigns:encounter_edit' campaign_id=enc.chapter.campaign.id chapter_id=enc.chapter.id encounter_id=enc.id %}"
                 class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200">
                Edit
              </a>
              <a href="{% url 'campaigns:encounter_delete' campaign_id=enc.chapter.campaign.id chapter_id=enc.chapter.id encounter_id=enc.id %}"
                 class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200">
                Delete
              </a>
            </div>
          </div>
          
          {% if enc.danger_level %}
          <div class="mb-2">
            <span class="inline-block px-2 py-1 text-xs rounded
              {% if enc.danger_level == 'low' %}bg-green-600 text-white
              {% elif enc.danger_level == 'moderate' %}bg-yellow-600 text-white
              {% elif enc.danger_level == 'high' %}bg-orange-600 text-white
              {% elif enc.danger_level == 'deadly' %}bg-red-600 text-white
              {% endif %}">
              {{ enc.get_danger_level_display }}
            </span>
          </div>
          {% endif %}
          
          <div class="prose prose-invert prose-sm max-w-none">
            <div><strong>Summary:</strong></div>
            <div class="ml-4 mb-3">{{ enc.summary|markdown }}</div>
            {% if enc.setup %}
            <div><strong>Setup:</strong></div>
            <div class="ml-4 mb-3">{{ enc.setup|markdown }}</div>
            {% endif %}
            {% if enc.read_aloud %}
            <div><strong>Read-Aloud:</strong></div>
            <div class="ml-4 mb-3 p-3 bg-gray-600 rounded border-l-4 border-indigo-500">{{ enc.read_aloud|markdown }}</div>
            {% endif %}
            {% if enc.dm_notes %}
            <div><strong>DM Notes:</strong></div>
            <div class="ml-4 mb-3">{{ enc.dm_notes|markdown }}</div>
            {% endif %}
          </div>
          {% if enc.tags %}
          <div class="mt-2 mb-4">
            <strong>Tags:</strong>
            {% for tag in enc.tags_as_list %}
            {% if tag.strip %}
            <span class="inline-block bg-gray-600 text-white px-2 py-1 text-xs rounded mr-1">{{ tag.strip }}</span>
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
          
          <!-- Location and NPCs Side-by-Side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <!-- Location Section -->
            <div>
              {% if enc.location %}
              <div class="mb-3">
                <strong class="text-blue-400">Location:</strong>
                <div class="flex flex-wrap gap-2 mt-1">
                  <a href="{% url 'campaigns:location_detail' campaign_id=enc.chapter.campaign.id location_id=enc.location.id %}" 
                     class="inline-flex items-center px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                    <i class="fas fa-map-marker-alt mr-1"></i>{{ enc.location.name }}
                    {% if enc.location.region %} - {{ enc.location.region }}{% endif %}
                  </a>
                </div>
              </div>
              {% endif %}
              {% if enc.map_reference %}
              <div class="mb-3">
                <strong class="text-blue-400">Map Ref:</strong>
                <div class="mt-1 prose prose-invert prose-sm max-w-none">
                  <div class="text-xs">{{ enc.map_reference|markdown }}</div>
                </div>
              </div>
              {% endif %}
            </div>
            
            <!-- NPCs Section -->
            <div>
              {% if enc.npcs.exists %}
              <div class="mb-3">
                <strong class="text-yellow-400">NPCs in this Encounter:</strong>
                <div class="flex flex-wrap gap-2 mt-1">
                  {% for npc in enc.npcs.all %}
                  <a href="{% url 'campaigns:npc_detail' campaign_id=enc.chapter.campaign.id npc_id=npc.id %}" 
                     class="inline-flex items-center px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                    <i class="fas fa-user mr-1"></i>{{ npc.name }}
                    {% if npc.role %} - {{ npc.role }}{% endif %}
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% elif enc.chapter.involved_npcs.exists %}
              <div class="mb-3">
                <strong class="text-yellow-400">Chapter NPCs:</strong>
                <div class="flex flex-wrap gap-2 mt-1">
                  {% for npc in enc.chapter.involved_npcs.all %}
                  <a href="{% url 'campaigns:npc_detail' campaign_id=enc.chapter.campaign.id npc_id=npc.id %}" 
                     class="inline-flex items-center px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded transition-colors">
                    <i class="fas fa-user mr-1"></i>{{ npc.name }}
                    {% if npc.role %} - {{ npc.role }}{% endif %}
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              
              <!-- Enemies Section -->
              {% if enc.enemies.exists %}
              <div>
                <strong class="text-red-400">Enemies:</strong>
                <div class="flex flex-wrap gap-2 mt-1">
                  {% for enemy in enc.enemies.all %}
                  <a href="{% url 'campaigns:enemy_detail' campaign_id=enc.chapter.campaign.id enemy_id=enemy.id %}" 
                     class="inline-flex items-center px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                    <i class="fas fa-user-ninja mr-1"></i>{{ enemy.name }}
                    <span class="ml-1 text-xs opacity-75">CR {{ enemy.challenge_rating }}</span>
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Location Map -->
        {% if enc.location.map_image %}
        <div class="lg:w-1/2 relative">
          <img
            src="{{ enc.location.map_image.url }}"
            class="w-full h-full object-cover rounded-b-lg lg:rounded-l-none lg:rounded-r-lg"
            alt="Map of {{ enc.location.name }}"
          />
          <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
            {{ enc.location.name }}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Enemy Management Section -->
      {% include "encounters/components/_enemies_section.html" with encounter=enc %}
      
      {% include "encounters/components/_notes_list.html" %}
    </div>
    {% endfor %} 
    
    <!-- Add Encounter Button at End of List -->
    {% if encounters %}
    <div class="text-center pt-6">
      <a href="{% url 'campaigns:encounter_create' campaign_id=chapter.campaign.id chapter_id=chapter.id %}" 
         class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-md text-sm transition duration-200 inline-flex items-center">
        <i class="fas fa-plus mr-2"></i>Add Another Encounter
      </a>
    </div>
    {% endif %}
    
    {% else %}
    <p class="text-gray-500">No encounters added yet.</p>
    {% endif %}
  </div>
</div>
