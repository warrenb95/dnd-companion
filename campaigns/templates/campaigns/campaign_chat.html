{% extends "base.html" %}
{% block title %}Chat - {{ campaign.title }}{% endblock %}
{% block content %}
<h2>Campaign Builder: {{ campaign.title }}</h2>
<div class="border rounded p-3 mb-3 bg-light" style="max-height: 60vh; overflow-y: auto;">
    {% for msg in messages %}
        <div class="mb-3">
            <strong>{{ msg.role|capfirst }}:</strong><br>
            <div style="white-space: pre-wrap;">{{ msg.content }}</div>
        </div>


        {% if msg.role == "user" %}
        <div class="mt-1">
          <a href="{% url 'campaigns:chat_edit' msg.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
          <a href="{% url 'campaigns:chat_delete' msg.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
        </div>
      {% endif %}
      {% if msg.role == "assistant" %}
        <form method="post" action="{% url 'campaigns:create_from_chat' campaign.id %}">
          {% csrf_token %}
          <input type="hidden" name="content" value="{{ msg.content|escape }}">
          <button class="btn btn-sm btn-outline-success mt-2">Extract NPC from Response</button>
        </form>

        <form method="post" action="{% url 'campaigns:create_locations_from_chat' campaign.id %}">
          {% csrf_token %}
          <input type="hidden" name="content" value="{{ msg.content|escape }}">
          <button class="btn btn-sm btn-outline-secondary mt-1">Extract Locations from Response</button>
        </form>

        <form method="post" action="{% url 'campaigns:save_campaign_summary' campaign.id %}">
          {% csrf_token %}
          <input type="hidden" name="content" value="{{ msg.content|escape }}">
          <button class="btn btn-sm btn-outline-primary mt-1">Save Summary</button>
        </form>
      {% endif %}
    {% empty %}
        <p>No conversation yet. Start asking!</p>
    {% endfor %}

</div>

<form method="post" class="mt-3">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Send</button>
</form>
<a href="{% url 'campaigns:campaign_detail' campaign.id %}" class="btn btn-link mt-2">Back to Campaign</a>
{% endblock %}
